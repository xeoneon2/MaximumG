<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Детские кнопки</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            height: 100vh;
            position: relative;
        }
        .top-alphabet {
            height: 10vh;
            background-color: #ffe6e6;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 10px;
            white-space: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
            z-index: 100;
            position: relative;
            cursor: grab;
        }
        .top-alphabet::-webkit-scrollbar { display: none; }
        .alphabet-letter {
            display: inline-block;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 4px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .alphabet-letter:active {
            transform: scale(1.2);
        }
        .color-palette {
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 10px;
            gap: 8px;
            background-color: #f0f8ff;
            z-index: 99;
            position: relative;
        }
        .palette-color {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .palette-color:active {
            transform: scale(1.2);
        }
        .main-grid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(90vh - 80px); /* 10vh + 60px палитры + 10px отступ */
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            z-index: 1;
        }
        button {
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.1s, box-shadow 0.1s;
            background-color: white;
            box-shadow: 0 6px 0 #ccc, 0 10px 15px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            z-index: 2;
        }
        button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #ccc, 0 5px 8px rgba(0,0,0,0.2);
        }
        .tap-highlight {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(0, 150, 255, 0.5);
            pointer-events: none;
            animation: fadeOut 0.5s forwards;
            z-index: 999;
        }
        @keyframes fadeOut {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.5); opacity: 0; }
        }
        .bubble {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: rgba(173, 216, 230, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: #000;
            cursor: pointer;
            z-index: 1000;
        }
        .firework-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1001;
        }
        .floating-draw {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 998;
        }
    </style>
</head>
<body>
    <div class="top-alphabet" id="alphabetCarousel"></div>
    <div class="color-palette" id="colorPalette"></div>
    <div class="main-grid" id="mainGrid">
        <button id="btn1">1</button>
        <button id="btn2">2</button>
        <button id="btn3">3</button>
        <button id="btn4">4</button>
        <button id="btn5">5</button>
        <button id="btn6">6</button>
        <button id="btn7">7</button>
        <button id="btn8">8</button>
        <button id="btn9">9</button>
    </div>

    <script>
        // === ГЛОБАЛЬНЫЕ СОСТОЯНИЯ ===
        let isNeonActive = false;
        let currentColorIndex = 0;
        const rainbowColors = ['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'];
        const russianAlphabet = 'АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ';
        let isDrawingMode = false;
        let isDrawing = false;
        let currentPath = [];
        let drawingColor = 'black';

        // === ЭЛЕМЕНТЫ ===
        const btn1 = document.getElementById('btn1');
        const btn2 = document.getElementById('btn2');
        const btn3 = document.getElementById('btn3');
        const btn4 = document.getElementById('btn4');
        const btn5 = document.getElementById('btn5');
        const btn6 = document.getElementById('btn6');
        const btn7 = document.getElementById('btn7');
        const btn8 = document.getElementById('btn8');
        const btn9 = document.getElementById('btn9');
        const mainGrid = document.getElementById('mainGrid');
        const alphabetCarousel = document.getElementById('alphabetCarousel');
        const colorPalette = document.getElementById('colorPalette');

        // === АЛФАВИТ ===
        russianAlphabet.split('').forEach(letter => {
            const el = document.createElement('div');
            el.className = 'alphabet-letter';
            el.textContent = letter;
            const handler = () => scheduleBubble(letter);
            el.addEventListener('click', handler);
            el.addEventListener('touchstart', e => { e.preventDefault(); handler(); });
            alphabetCarousel.appendChild(el);
        });

        // === ПАЛИТРА ЦВЕТОВ ===
        const paletteColors = ['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet', 'black', 'white'];
        paletteColors.forEach(color => {
            const el = document.createElement('div');
            el.className = 'palette-color';
            el.style.backgroundColor = color;
            const handler = () => { drawingColor = color; };
            el.addEventListener('click', handler);
            el.addEventListener('touchstart', e => { e.preventDefault(); handler(); });
            colorPalette.appendChild(el);
        });

        // === DRAG-TO-SCROLL ДЛЯ КАРУСЕЛИ ===
        let isDown = false;
        let startX;
        let scrollLeft;

        alphabetCarousel.addEventListener('mousedown', (e) => {
            isDown = true;
            startX = e.pageX - alphabetCarousel.offsetLeft;
            scrollLeft = alphabetCarousel.scrollLeft;
            alphabetCarousel.style.cursor = 'grabbing';
        });

        alphabetCarousel.addEventListener('mouseleave', () => {
            isDown = false;
            alphabetCarousel.style.cursor = 'grab';
        });

        alphabetCarousel.addEventListener('mouseup', () => {
            isDown = false;
            alphabetCarousel.style.cursor = 'grab';
        });

        alphabetCarousel.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - alphabetCarousel.offsetLeft;
            const walk = (x - startX) * 2;
            alphabetCarousel.scrollLeft = scrollLeft - walk;
        });

        let touchStartX;
        alphabetCarousel.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].pageX;
        });

        alphabetCarousel.addEventListener('touchmove', (e) => {
            if (!touchStartX) return;
            const diff = touchStartX - e.touches[0].pageX;
            alphabetCarousel.scrollLeft += diff;
            touchStartX = e.touches[0].pageX;
        });

        alphabetCarousel.addEventListener('touchend', () => {
            touchStartX = null;
        });

        // === РИСОВАНИЕ ===
        function startDrawing(x, y) {
            if (!isDrawingMode) return;
            isDrawing = true;
            currentPath = [{x, y}];
        }

        function continueDrawing(x, y) {
            if (!isDrawing || !isDrawingMode) return;
            currentPath.push({x, y});
            drawPath(currentPath, drawingColor);
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            if (isDrawingMode) {
                launchDrawing(currentPath, drawingColor);
                currentPath = [];
            }
        }

        function drawPath(path, color) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = window.innerWidth;
            tempCanvas.height = window.innerHeight;
            const ctx = tempCanvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineWidth = 12;
            ctx.strokeStyle = color;
            ctx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            if (path.length < 2) return;
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }
            ctx.stroke();
            const overlay = document.getElementById('temp-draw-overlay');
            if (overlay) overlay.remove();
            const newOverlay = document.createElement('div');
            newOverlay.id = 'temp-draw-overlay';
            newOverlay.style.position = 'absolute';
            newOverlay.style.top = '0';
            newOverlay.style.left = '0';
            newOverlay.style.width = '100%';
            newOverlay.style.height = '100%';
            newOverlay.style.pointerEvents = 'none';
            newOverlay.style.backgroundImage = `url(${tempCanvas.toDataURL()})`;
            newOverlay.style.backgroundRepeat = 'no-repeat';
            newOverlay.style.zIndex = '998';
            document.body.appendChild(newOverlay);
        }

        function launchDrawing(path, color) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = window.innerWidth;
            tempCanvas.height = window.innerHeight;
            const ctx = tempCanvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineWidth = 12;
            ctx.strokeStyle = color;
            if (path.length < 2) return;
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }
            ctx.stroke();
            const floating = document.createElement('div');
            floating.className = 'floating-draw';
            floating.style.backgroundImage = `url(${tempCanvas.toDataURL()})`;
            floating.style.backgroundRepeat = 'no-repeat';
            floating.style.backgroundSize = '100% 100%';
            floating.style.width = '100%';
            floating.style.height = '100%';
            document.body.appendChild(floating);
            let y = 0;
            const duration = 3000;
            const startTime = Date.now();
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                y = -progress * window.innerHeight * 1.2;
                floating.style.transform = `translateY(${y}px)`;
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    floating.remove();
                }
            }
            requestAnimationFrame(animate);
            document.getElementById('temp-draw-overlay')?.remove();
        }

        document.body.addEventListener('mousedown', e => startDrawing(e.clientX, e.clientY));
        document.body.addEventListener('mousemove', e => continueDrawing(e.clientX, e.clientY));
        document.body.addEventListener('mouseup', stopDrawing);
        document.body.addEventListener('mouseleave', stopDrawing);
        document.body.addEventListener('touchstart', e => {
            e.preventDefault();
            const t = e.touches[0];
            startDrawing(t.clientX, t.clientY);
        });
        document.body.addEventListener('touchmove', e => {
            e.preventDefault();
            const t = e.touches[0];
            continueDrawing(t.clientX, t.clientY);
        });
        document.body.addEventListener('touchend', stopDrawing);

        // === ПУЗЫРИ И ФЕЙЕРВЕРКИ ===
        function scheduleBubble(letter) {
            setTimeout(() => createBubble(letter), 2000);
        }

        function createBubble(letter) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.textContent = letter;
            const startX = Math.random() * (window.innerWidth - 120);
            const startY = window.innerHeight + 120;
            bubble.style.left = `${startX}px`;
            bubble.style.top = `${startY}px`;
            document.body.appendChild(bubble);
            let x = startX;
            let y = startY;
            const speedY = -3 - Math.random() * 4;
            const driftX = (Math.random() - 0.5) * 2;
            const rotation = (Math.random() - 0.5) * 10;
            let rot = 0;
            function animateBubble() {
                y += speedY;
                x += driftX;
                rot += rotation;
                bubble.style.top = `${y}px`;
                bubble.style.left = `${x}px`;
                bubble.style.transform = `rotate(${rot}deg)`;
                if (y < -150) {
                    bubble.remove();
                    return;
                }
                requestAnimationFrame(animateBubble);
            }
            animateBubble();
            bubble.addEventListener('click', () => popBubble(bubble, letter));
            bubble.addEventListener('touchstart', e => { e.preventDefault(); popBubble(bubble, letter); });
        }

        function popBubble(bubble, letter) {
            speakLetter(letter);
            createFirework(
                parseFloat(bubble.style.left) + 60,
                parseFloat(bubble.style.top) + 60
            );
            bubble.remove();
        }

        function speakLetter(letter) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(letter);
                utterance.lang = 'ru-RU';
                speechSynthesis.speak(utterance);
            }
        }

        function createFirework(x, y) {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffffff'];
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                document.body.appendChild(particle);
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 5;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;
                let posX = x, posY = y, opacity = 1;
                const animate = () => {
                    posX += vx;
                    posY += vy;
                    opacity -= 0.02;
                    if (opacity <= 0) {
                        particle.remove();
                        return;
                    }
                    particle.style.left = `${posX}px`;
                    particle.style.top = `${posY}px`;
                    particle.style.opacity = opacity;
                    requestAnimationFrame(animate);
                };
                animate();
            }
        }

        // === ЗВУК ===
        let audioContext = null;
        let currentInstrumentIndex = 0;
        const instruments = ['piano', 'pluck', 'synth'];
        const notes = {
            1: 261.63, // C4
            2: 293.66, // D4
            3: 329.63, // E4
            4: 349.23, // F4
            5: 392.00, // G4
            6: 440.00, // A4
            7: 493.88  // B4
        };

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playNote(freq, duration = 0.6) {
            initAudioContext();
            const now = audioContext.currentTime;
            const oscillator = audioContext.createOscillator();
            const gain = audioContext.createGain();
            let filter = null;
            const instrument = instruments[currentInstrumentIndex];
            if (instrument === 'piano') {
                oscillator.type = 'sine';
                gain.gain.setValueAtTime(0.4, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + duration);
            } else if (instrument === 'pluck') {
                oscillator.type = 'sine';
                gain.gain.setValueAtTime(0.0, now);
                gain.gain.setValueAtTime(0.5, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + duration);
            } else if (instrument === 'synth') {
                oscillator.type = 'sawtooth';
                filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(2000, now);
                filter.frequency.exponentialRampToValueAtTime(800, now + duration);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + duration);
            }
            oscillator.frequency.value = freq;
            oscillator.connect(filter || gain);
            if (filter) filter.connect(gain);
            gain.connect(audioContext.destination);
            oscillator.start(now);
            oscillator.stop(now + duration);
        }

        // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===
        function highlightTap(x, y) {
            const highlight = document.createElement('div');
            highlight.className = 'tap-highlight';
            highlight.style.left = `${x - 30}px`;
            highlight.style.top = `${y - 30}px`;
            document.body.appendChild(highlight);
            setTimeout(() => highlight.remove(), 500);
        }

        function interpolateColor(color1, color2, factor) {
            const r1 = parseInt(color1.substring(1, 3), 16);
            const g1 = parseInt(color1.substring(3, 5), 16);
            const b1 = parseInt(color1.substring(5, 7), 16);
            const r2 = parseInt(color2.substring(1, 3), 16);
            const g2 = parseInt(color2.substring(3, 5), 16);
            const b2 = parseInt(color2.substring(5, 7), 16);
            const r = Math.round(r1 + factor * (r2 - r1));
            const g = Math.round(g1 + factor * (g2 - g1));
            const b = Math.round(b1 + factor * (b2 - b1));
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        function animateColorChange(buttons, targetColor, duration = 300) {
            const startColor = getComputedStyle(buttons[0]).backgroundColor;
            let startHex = startColor;
            if (startColor.startsWith('rgb')) {
                const [r, g, b] = startColor.match(/\d+/g).map(Number);
                startHex = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            let startTime = null;
            const animate = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentColor = interpolateColor(startHex, targetColor, progress);
                buttons.forEach(button => {
                    button.style.backgroundColor = currentColor;
                    if (isNeonActive) {
                        button.style.boxShadow = `0 0 10px ${currentColor}, 0 0 20px ${currentColor}, 0 0 30px ${currentColor}`;
                    }
                });
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    buttons.forEach(button => {
                        button.style.backgroundColor = targetColor;
                        if (isNeonActive) {
                            button.style.boxShadow = `0 0 10px ${targetColor}, 0 0 20px ${targetColor}, 0 0 30px ${targetColor}`;
                        }
                    });
                }
            };
            requestAnimationFrame(animate);
        }

        // === ОБРАБОТЧИКИ КНОПОК ===
        const allButtons = [btn1, btn2, btn3, btn4, btn5, btn6, btn7, btn8, btn9];

        // Кнопки 1–7: ноты + цвет + рисование
        [1,2,3,4,5,6,7].forEach(num => {
            const btn = document.getElementById(`btn${num}`);
            const handler = (e) => {
                highlightTap(e.clientX || e.touches[0]?.clientX, e.clientY || e.touches[0]?.clientY);
                const newColor = rainbowColors[currentColorIndex];
                animateColorChange(allButtons, newColor);
                currentColorIndex = (currentColorIndex + 1) % rainbowColors.length;
                if (notes[num]) playNote(notes[num]);
                isDrawingMode = true;
                drawingColor = rainbowColors[num - 1] || 'black';
            };
            btn.addEventListener('click', handler);
            btn.addEventListener('touchstart', e => { e.preventDefault(); handler(e); });
        });

        // Кнопка 5 — неон (остаётся)
        btn5.addEventListener('click', () => {
            isNeonActive = !isNeonActive;
            if (isNeonActive) {
                allButtons.forEach(button => {
                    const currentColor = getComputedStyle(button).backgroundColor;
                    let hex = currentColor;
                    if (currentColor.startsWith('rgb')) {
                        const [r, g, b] = currentColor.match(/\d+/g).map(Number);
                        hex = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                    }
                    button.style.boxShadow = `0 0 10px ${hex}, 0 0 20px ${hex}, 0 0 30px ${hex}`;
                });
            } else {
                allButtons.forEach(button => {
                    button.style.boxShadow = '0 6px 0 #ccc, 0 10px 15px rgba(0,0,0,0.2)';
                });
            }
        });
        btn5.addEventListener('touchstart', e => { e.preventDefault(); btn5.click(); });

        // Кнопки 8 и 9 — только инструменты
        btn8.addEventListener('click', () => {
            currentInstrumentIndex = (currentInstrumentIndex - 1 + instruments.length) % instruments.length;
        });
        btn8.addEventListener('touchstart', e => { e.preventDefault(); btn8.click(); });

        btn9.addEventListener('click', () => {
            currentInstrumentIndex = (currentInstrumentIndex + 1) % instruments.length;
        });
        btn9.addEventListener('touchstart', e => { e.preventDefault(); btn9.click(); });

        // === ИНИЦИАЛИЗАЦИЯ AUDIO ===
        function initOnFirstInteraction() {
            initAudioContext();
            document.body.removeEventListener('touchstart', initOnFirstInteraction);
            document.body.removeEventListener('mousedown', initOnFirstInteraction);
        }
        document.body.addEventListener('touchstart', initOnFirstInteraction, { once: true });
        document.body.addEventListener('mousedown', initOnFirstInteraction, { once: true });
    </script>
</body>
</html>